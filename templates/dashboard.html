{% extends "./layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block customCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
{% endblock %}
{% block body %}

<body>
	<nav class="navbar navbar-expand-lg sticky-top">
		<div class="container-fluid">
			<a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') }}">
				<img src="{{ url_for('static', filename='img/WhatsAnalyzer v2.png') }}" alt="" width="20" height="20" class="d-inline-block align-text-top me-2" />
				<span class="fw-bold">WhatsAnalyzer</span>
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('dashboard') }}">Dashboard</a></li>
				</ul>
				<div class="d-flex align-items-center gap-3">
					<button type="button" class="btn btn-sm btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#uploadModal">
						<i class="bi bi-upload me-1"></i> Upload chat
					</button>
					<div class="form-check form-switch mb-0">
						<input class="form-check-input" type="checkbox" id="darkModeSwitch" />
					</div>
					<span class="version-badge">v2.0</span>
				</div>
			</div>
		</div>
	</nav>

	<!-- Progress Navigation Bar -->
	<div class="progress-nav-bar" id="progressNavBar">
		<div class="progress-line" id="progressLine"></div>
		<div class="progress-point active" data-section="overview" title="Overview">
			<span class="progress-label">Overview</span>
		</div>
		<div class="progress-point" data-section="main-stats" title="Main Statistics">
			<span class="progress-label">Main Stats</span>
		</div>
		<div class="progress-point" data-section="activity-charts" title="Activity Charts">
			<span class="progress-label">Activity</span>
		</div>
		<div class="progress-point" data-section="usage-charts" title="Usage Patterns">
			<span class="progress-label">Usage</span>
		</div>
		<div class="progress-point" data-section="emoji-charts" title="Emoji Analysis">
			<span class="progress-label">Emojis</span>
		</div>
		<div class="progress-point" data-section="stats-charts" title="Statistics">
			<span class="progress-label">Statistics</span>
		</div>
		<div class="progress-point" data-section="response-charts" title="Response Analysis">
			<span class="progress-label">Response</span>
		</div>
	</div>

	<div class="container py-4">
		{% with messages = get_flashed_messages() %}
		{% if messages %}
		<div class="row">
			<div class="col-12">
				{% for message in messages %}
				<div class="alert alert-primary alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endif %}
		{% endwith %}

		<div id="empty-state" class="py-5 text-center" data-section-content="overview">
			<div class="mb-3">
				<span class="badge text-bg-primary"><i class="bi bi-stars me-1"></i> Smart chat analysis</span>
			</div>
			<h2 class="fw-bold mb-2">Discover insights from your<br><span class="gradient-text">WhatsApp conversations</span></h2>
			<p class="text-muted mb-4">Upload your exported chat file and get detailed statistics about messages, emojis, most used words and activity patterns.</p>
			<div class="d-flex justify-content-center gap-3 mb-5">
				<button class="btn btn-outline-primary" id="use-demo-btn"><i class="bi bi-magic me-1"></i>Try demo chat</button>
				<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="bi bi-cloud-arrow-up me-1"></i>Upload your chat</button>
			</div>

			<div class="row g-4 justify-content-center mt-4" style="max-width: 900px; margin: 0 auto;">
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-bar-chart-line-fill"></i>
						</div>
						<h6>Detailed statistics</h6>
						<p>Total messages, words, emojis and much more in a single view.</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-people-fill"></i>
						</div>
						<h6>Participant analysis</h6>
						<p>Discover who sends more messages and their communication style.</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-clock-history"></i>
						</div>
						<h6>Temporal patterns</h6>
						<p>Visualize activity by hour and day of the week.</p>
					</div>
				</div>
			</div>

			<div class="footer-note mt-5">
				<i class="bi bi-shield-lock-fill me-1"></i> Your data never leaves your browser. 100% private and secure.
			</div>
		</div>

		<div id="stats-content" class="d-none">
			<div id="main-stats" class="row g-3 mb-4" data-section-content="main-stats">
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 0">
						<div class="card-body">
							<div class="stat-icon green">
								<i class="bi bi-chat-text-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Total messages</h6>
							<h3 id="total-messages-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 1">
						<div class="card-body">
							<div class="stat-icon purple">
								<i class="bi bi-people-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Participants</h6>
							<h3 id="participants-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 2">
						<div class="card-body">
							<div class="stat-icon cyan">
								<i class="bi bi-calendar-check-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Active days</h6>
							<h3 id="active-days-value">--</h3>
							<small class="text-muted" id="active-days-detail"></small>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 3">
						<div class="card-body">
							<div class="stat-icon yellow">
								<i class="bi bi-calendar-range-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Time span</h6>
							<p class="mb-0 fw-semibold" id="time-span-value">--</p>
							<small class="text-muted" id="total-dias-value"></small>
						</div>
					</div>
				</div>
			</div>

			<div class="row g-3 mb-4">
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 4">
						<div class="card-body">
							<div class="stat-icon orange">
								<i class="bi bi-graph-up-arrow"></i>
							</div>
							<h6 class="text-muted mb-1">Avg. messages/day</h6>
							<h3 id="avg-messages-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 5">
						<div class="card-body">
							<div class="stat-icon pink">
								<i class="bi bi-hourglass-split"></i>
							</div>
							<h6 class="text-muted mb-1">Hours chatting</h6>
							<h3 id="hours-chatting-value">--</h3>
							<small class="text-muted">time "wasted" ðŸ˜…</small>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 6">
						<div class="card-body">
							<div class="stat-icon yellow">
								<i class="bi bi-emoji-smile-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Emojis used</h6>
							<h3 id="emoji-count-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 7">
						<div class="card-body">
							<div class="stat-icon cyan">
								<i class="bi bi-image-fill"></i>
							</div>
							<h6 class="text-muted mb-1">Media shared</h6>
							<h3 id="media-shared-value">--</h3>
						</div>
					</div>
				</div>
			</div>

			<div id="activity-charts" class="row g-4 mb-4" data-section-content="activity-charts">
				<div class="col-lg-8">
					<div class="card h-100 stat-card animate-in" style="--delay: 8">
						<div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
							<h5 class="mb-0"><i class="bi bi-graph-up-arrow icon-green me-2"></i>Messages per day</h5>
							<div class="d-flex align-items-center gap-2">
								<label for="message-range" class="form-label mb-0 small text-muted">Range</label>
								<select id="message-range" class="form-select form-select-sm w-auto">
									<option value="7d">Last 7 days</option>
									<option value="30d">Last 30 days</option>
									<option value="3m">Last 3 months</option>
									<option value="6m">Last 6 months</option>
									<option value="1y">Last year</option>
									<option value="all" selected>All time</option>
								</select>
							</div>
						</div>
						<div class="card-body">
							<canvas id="messageActivityChart" height="180"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-4">
					<div class="card h-100 stat-card animate-in" style="--delay: 9">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-people-fill icon-purple me-2"></i>Participants</h5>
						</div>
						<div class="card-body">
							<canvas id="participantChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="usage-charts" class="row g-4 mb-4" data-section-content="usage-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 10">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-clock-fill icon-cyan me-2"></i>Activity by hour</h5>
						</div>
						<div class="card-body">
							<canvas id="hourActivityChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 11">
						<div class="card-header d-flex justify-content-between align-items-center">
							<h5 class="mb-0"><i class="bi bi-chat-square-text-fill icon-orange me-2"></i>Most used words</h5>
						</div>
						<div class="card-body">
							<canvas id="wordCloudChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="emoji-charts" class="row g-4 mb-4" data-section-content="emoji-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-emoji-smile-fill icon-yellow me-2"></i>Favorite emojis</h5>
						</div>
						<div class="card-body">
							<canvas id="mostUsedEmojisChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-emoji-laughing-fill icon-pink me-2"></i>Emojis by user</h5>
						</div>
						<div class="card-body">
							<canvas id="emojiUsageByUserChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="stats-charts" class="row g-4 mb-4" data-section-content="stats-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-pie-chart-fill icon-green me-2"></i>Participation (message %)</h5>
						</div>
						<div class="card-body">
							<canvas id="responseRateChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-trophy-fill icon-yellow me-2"></i>Conversation starters</h5>
						</div>
						<div class="card-body">
							<div id="conversation-starters-podium" class="d-flex flex-column gap-3"></div>
						</div>
					</div>
				</div>
			</div>

			<div id="response-charts" class="row g-4 mb-4" data-section-content="response-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-lightning-fill icon-cyan me-2"></i>Avg. response time</h5>
						</div>
						<div class="card-body">
							<div id="response-time-chart-container">
								<canvas id="responseTimeChart" height="220"></canvas>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-pencil-fill icon-orange me-2"></i>Avg. words per message</h5>
						</div>
						<div class="card-body">
							<canvas id="wordsPerMessageChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div class="row mb-4">
				<div class="col-12">
					<div class="card download-section animate-in" style="--delay: 3">
						<div class="card-body d-flex justify-content-center gap-3 flex-wrap py-4">
							<button class="btn btn-outline-primary" id="download-json-btn">
								<i class="bi bi-filetype-json me-1"></i> Download JSON
							</button>
							<button class="btn btn-outline-primary" id="download-png-btn">
								<i class="bi bi-image me-1"></i> Download PNG
							</button>
						</div>
					</div>
				</div>
			</div>

			<div class="footer-note">
				<i class="bi bi-shield-lock-fill me-1"></i> Your data never leaves your browser. 100% private and secure.
			</div>
		</div>

		<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form action="{{ url_for('dashboard') }}" method="POST" enctype="multipart/form-data">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
						<div class="modal-header">
							<h5 class="modal-title" id="uploadModalLabel">Upload WhatsApp chat</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<p class="mb-2">Export your chat without media and upload the .txt file.</p>
							<div class="mb-3">
								<label for="chatFile" class="form-label">.txt file</label>
								<input class="form-control" type="file" id="chatFile" name="chatFile" accept=".txt" required />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" class="btn btn-primary">Analyze</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud@4"></script>
		<script id="chat-data" type="application/json">{{ stats_json | safe }}</script>
		<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
		<script>
			// Progress Navigation Bar functionality
			document.addEventListener('DOMContentLoaded', function () {
				const progressNavBar = document.getElementById('progressNavBar');
				const progressLine = document.getElementById('progressLine');
				const progressPoints = document.querySelectorAll('.progress-point');
				const sections = document.querySelectorAll('[data-section-content]');

				// Only show progress bar when stats are visible
				function updateProgressBarVisibility() {
					const statsContent = document.getElementById('stats-content');
					if (statsContent && !statsContent.classList.contains('d-none')) {
						progressNavBar.classList.add('visible');
					} else {
						progressNavBar.classList.remove('visible');
					}
				}

				// Update progress line and active points based on scroll
				function updateProgress() {
					if (!progressNavBar.classList.contains('visible')) return;

					const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
					const windowHeight = window.innerHeight;
					const documentHeight = document.documentElement.scrollHeight;

					let currentSection = null;
					let maxProgress = 0;

					// Find current section
					sections.forEach((section, index) => {
						const rect = section.getBoundingClientRect();
						const sectionTop = rect.top + scrollTop;
						const sectionBottom = sectionTop + rect.height;
						const threshold = windowHeight * 0.3;

						if (scrollTop + threshold >= sectionTop && scrollTop < sectionBottom) {
							currentSection = section.getAttribute('data-section-content');
							maxProgress = index;
						}
					});

					// Update active points
					progressPoints.forEach((point, index) => {
						if (index <= maxProgress) {
							point.classList.add('active');
						} else {
							point.classList.remove('active');
						}

						if (point.getAttribute('data-section') === currentSection) {
							point.classList.add('current');
						} else {
							point.classList.remove('current');
						}
					});

					// Update progress line height
					if (progressPoints.length > 0) {
						const firstPoint = progressPoints[0];
						const lastActivePoint = progressPoints[maxProgress];
						if (lastActivePoint) {
							const height = lastActivePoint.offsetTop - firstPoint.offsetTop;
							progressLine.style.height = `${height}px`;
						}
					}
				}

				// Smooth scroll to section
				progressPoints.forEach(point => {
					point.addEventListener('click', () => {
						const sectionName = point.getAttribute('data-section');
						const targetSection = document.querySelector(`[data-section-content="${sectionName}"]`);
						if (targetSection) {
							const offsetTop = targetSection.offsetTop - 80; // Account for navbar
							window.scrollTo({
								top: offsetTop,
								behavior: 'smooth'
							});
						}
					});
				});

				// Listen for scroll events
				let scrollTimeout;
				window.addEventListener('scroll', () => {
					clearTimeout(scrollTimeout);
					scrollTimeout = setTimeout(updateProgress, 10);
				});

				// Watch for stats content visibility changes
				const observer = new MutationObserver(updateProgressBarVisibility);
				const statsContent = document.getElementById('stats-content');
				if (statsContent) {
					observer.observe(statsContent, { attributes: true, attributeFilter: ['class'] });
				}

				// Initial update
				updateProgressBarVisibility();
				setTimeout(updateProgress, 100);
			});

			// Fix mobile navbar toggle - close menu when clicking links or outside
			document.addEventListener('DOMContentLoaded', function () {
				const navbarCollapse = document.getElementById('navbarSupportedContent');
				const navbarToggler = document.querySelector('.navbar-toggler');

				// Close navbar when clicking a nav link on mobile
				document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
					link.addEventListener('click', () => {
						if (window.innerWidth < 992 && navbarCollapse.classList.contains('show')) {
							bootstrap.Collapse.getInstance(navbarCollapse)?.hide();
						}
					});
				});

				// Close navbar when clicking outside
				document.addEventListener('click', (e) => {
					if (window.innerWidth < 992 &&
						navbarCollapse.classList.contains('show') &&
						!navbarCollapse.contains(e.target) &&
						!navbarToggler.contains(e.target)) {
						bootstrap.Collapse.getInstance(navbarCollapse)?.hide();
					}
				});
			});
		</script>

</body>

{% endblock %}