{% extends "./layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block customCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
<style>
	/* Theme switch icons */
	.theme-switch-container {
		display: inline-flex;
		align-items: center;
		gap: .4rem;
	}

	.theme-icon {
		font-size: 1rem;
		cursor: pointer;
		color: var(--bs-body-color);
		opacity: .85;
		display: inline-flex;
		align-items: center;
	}

	.theme-icon:active {
		transform: scale(.95);
	}

	.theme-icon:hover {
		opacity: 1;
	}
</style>
{% endblock %}
{% block body %}

<body>
	<nav class="navbar navbar-expand-lg sticky-top">
		<div class="container-fluid">
			<a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') }}">
				<img src="{{ url_for('static', filename='img/WhatsAnalyzer v2.png') }}" alt="" width="20" height="20" class="d-inline-block align-text-top me-2" />
				<span class="fw-bold">WhatsAnalyzer</span>
			</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('dashboard') }}" data-i18n="nav.dashboard">Dashboard</a></li>
				</ul>
				<div class="d-flex align-items-center gap-3">
					<button type="button" class="btn btn-sm btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#uploadModal">
						<i class="bi bi-upload me-1"></i><span data-i18n="nav.uploadChat">Upload chat</span>
					</button>
					<select id="languageSelect" class="form-select form-select-sm" style="width: auto; min-width: 90px;">
						<option value="en">ðŸ‡ºðŸ‡¸ EN</option>
						<option value="es">ðŸ‡ªðŸ‡¸ ES</option>
					</select>
					<div class="theme-switch-container">
						<i class="bi bi-sun-fill theme-icon" role="button" tabindex="0" title="Light" aria-label="Light mode" onclick="document.getElementById('darkModeSwitch').click()"></i>
						<div class="form-check form-switch mb-0">
							<input class="form-check-input" type="checkbox" id="darkModeSwitch" />
						</div>
						<i class="bi bi-moon-fill theme-icon" role="button" tabindex="0" title="Dark" aria-label="Dark mode" onclick="document.getElementById('darkModeSwitch').click()"></i>
					</div>
					<span class="version-badge">v2.0</span>
				</div>
			</div>
		</div>
	</nav>

	<!-- Progress Navigation Bar -->
	<div class="progress-nav-bar" id="progressNavBar">
		<div class="progress-line" id="progressLine"></div>
		<div class="progress-point active" data-section="overview" data-i18n-title="progress.overview">
			<span class="progress-label" data-i18n="progress.overview">Overview</span>
		</div>
		<div class="progress-point" data-section="main-stats" data-i18n-title="progress.mainStats">
			<span class="progress-label" data-i18n="progress.mainStats">Main Stats</span>
		</div>
		<div class="progress-point" data-section="activity-charts" data-i18n-title="progress.activity">
			<span class="progress-label" data-i18n="progress.activity">Activity</span>
		</div>
		<div class="progress-point" data-section="usage-charts" data-i18n-title="progress.usage">
			<span class="progress-label" data-i18n="progress.usage">Usage</span>
		</div>
		<div class="progress-point" data-section="emoji-charts" data-i18n-title="progress.emojis">
			<span class="progress-label" data-i18n="progress.emojis">Emojis</span>
		</div>
		<div class="progress-point" data-section="sentiment-charts" data-i18n-title="progress.sentiment">
			<span class="progress-label" data-i18n="progress.sentiment">Sentiment</span>
		</div>
		<div class="progress-point" data-section="stats-charts" data-i18n-title="progress.statistics">
			<span class="progress-label" data-i18n="progress.statistics">Statistics</span>
		</div>
		<div class="progress-point" data-section="response-charts" data-i18n-title="progress.response">
			<span class="progress-label" data-i18n="progress.response">Response</span>
		</div>
	</div>

	<div class="container py-4">
		{% with messages = get_flashed_messages() %}
		{% if messages %}
		<div class="row">
			<div class="col-12">
				{% for message in messages %}
				<div class="alert alert-primary alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endif %}
		{% endwith %}

		<div id="empty-state" class="py-5 text-center" data-section-content="overview">
			<div class="mb-3">
				<span class="badge text-bg-primary"><i class="bi bi-stars me-1"></i><span data-i18n="empty.badge">Smart chat analysis</span></span>
			</div>
			<h2 class="fw-bold mb-2"><span data-i18n="empty.title">Discover insights from your</span><br><span class="gradient-text" data-i18n="empty.titleHighlight">WhatsApp conversations</span></h2>
			<p class="text-muted mb-4" data-i18n="empty.description">Upload your exported chat file and get detailed statistics about messages, emojis, most used words and activity patterns.</p>
			<div class="d-flex justify-content-center gap-3 mb-5">
				<button class="btn btn-outline-primary" id="use-demo-btn"><i class="bi bi-magic me-1"></i><span data-i18n="empty.demoBtn">Try demo chat</span></button>
				<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="bi bi-cloud-arrow-up me-1"></i><span data-i18n="empty.uploadBtn">Upload your chat</span></button>
			</div>

			<div class="row g-4 justify-content-center mt-4" style="max-width: 900px; margin: 0 auto;">
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-bar-chart-line-fill"></i>
						</div>
						<h6 data-i18n="feature.stats.title">Detailed statistics</h6>
						<p data-i18n="feature.stats.desc">Total messages, words, emojis and much more in a single view.</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-people-fill"></i>
						</div>
						<h6 data-i18n="feature.participants.title">Participant analysis</h6>
						<p data-i18n="feature.participants.desc">Discover who sends more messages and their communication style.</p>
					</div>
				</div>
				<div class="col-md-4">
					<div class="feature-card">
						<div class="icon-wrapper">
							<i class="bi bi-clock-history"></i>
						</div>
						<h6 data-i18n="feature.temporal.title">Temporal patterns</h6>
						<p data-i18n="feature.temporal.desc">Visualize activity by hour and day of the week.</p>
					</div>
				</div>
			</div>

			<div class="footer-note mt-5">
				<i class="bi bi-shield-lock-fill me-1"></i><span data-i18n="footer.privacy">Your data never leaves your browser. 100% private and secure.</span>
			</div>
		</div>

		<div id="stats-content" class="d-none">
			<div id="main-stats" class="row g-3 mb-4" data-section-content="main-stats">
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 0">
						<div class="card-body">
							<div class="stat-icon green">
								<i class="bi bi-chat-text-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.totalMessages">Total messages</h6>
							<h3 id="total-messages-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 1">
						<div class="card-body">
							<div class="stat-icon purple">
								<i class="bi bi-people-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.participants">Participants</h6>
							<h3 id="participants-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 2">
						<div class="card-body">
							<div class="stat-icon cyan">
								<i class="bi bi-calendar-check-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.activeDays">Active days</h6>
							<h3 id="active-days-value">--</h3>
							<small class="text-muted" id="active-days-detail"></small>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 3">
						<div class="card-body">
							<div class="stat-icon yellow">
								<i class="bi bi-calendar-range-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.timeSpan">Time span</h6>
							<p class="mb-0 fw-semibold" id="time-span-value">--</p>
							<small class="text-muted" id="total-dias-value"></small>
						</div>
					</div>
				</div>
			</div>

			<div class="row g-3 mb-4">
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 4">
						<div class="card-body">
							<div class="stat-icon orange">
								<i class="bi bi-graph-up-arrow"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.avgMessages">Avg. messages/day</h6>
							<h3 id="avg-messages-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 5">
						<div class="card-body">
							<div class="stat-icon pink">
								<i class="bi bi-hourglass-split"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.hoursChatting">Hours chatting</h6>
							<h3 id="hours-chatting-value">--</h3>
							<small class="text-muted" data-i18n="stats.timeWasted">time "wasted" ðŸ˜…</small>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 6">
						<div class="card-body">
							<div class="stat-icon yellow">
								<i class="bi bi-emoji-smile-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.emojisUsed">Emojis used</h6>
							<h3 id="emoji-count-value">--</h3>
						</div>
					</div>
				</div>
				<div class="col-6 col-lg-3">
					<div class="card stat-card h-100 animate-in" style="--delay: 7">
						<div class="card-body">
							<div class="stat-icon cyan">
								<i class="bi bi-image-fill"></i>
							</div>
							<h6 class="text-muted mb-1" data-i18n="stats.mediaShared">Media shared</h6>
							<h3 id="media-shared-value">--</h3>
						</div>
					</div>
				</div>
			</div>

			<div id="activity-charts" class="row g-4 mb-4" data-section-content="activity-charts">
				<div class="col-lg-8">
					<div class="card h-100 stat-card animate-in" style="--delay: 8">
						<div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
							<h5 class="mb-0"><i class="bi bi-graph-up-arrow icon-green me-2"></i><span data-i18n="chart.messagesPerDay">Messages per day</span></h5>
							<div class="d-flex align-items-center gap-2">
								<label for="message-range" class="form-label mb-0 small text-muted" data-i18n="chart.range">Range</label>
								<select id="message-range" class="form-select form-select-sm w-auto">
									<option value="7d" data-i18n="chart.last7days">Last 7 days</option>
									<option value="30d" data-i18n="chart.last30days">Last 30 days</option>
									<option value="3m" data-i18n="chart.last3months">Last 3 months</option>
									<option value="6m" data-i18n="chart.last6months">Last 6 months</option>
									<option value="1y" data-i18n="chart.lastYear">Last year</option>
									<option value="all" selected data-i18n="chart.allTime">All time</option>
								</select>
							</div>
						</div>
						<div class="card-body">
							<canvas id="messageActivityChart" height="180"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-4">
					<div class="card h-100 stat-card animate-in" style="--delay: 9">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-people-fill icon-purple me-2"></i><span data-i18n="chart.participants">Participants</span></h5>
						</div>
						<div class="card-body">
							<canvas id="participantChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="usage-charts" class="row g-4 mb-4" data-section-content="usage-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 10">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-clock-fill icon-cyan me-2"></i><span data-i18n="chart.activityByHour">Activity by hour</span></h5>
						</div>
						<div class="card-body">
							<canvas id="hourActivityChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 11">
						<div class="card-header d-flex justify-content-between align-items-center">
							<h5 class="mb-0"><i class="bi bi-chat-square-text-fill icon-orange me-2"></i><span data-i18n="chart.mostUsedWords">Most used words</span></h5>
						</div>
						<div class="card-body">
							<canvas id="wordCloudChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="emoji-charts" class="row g-4 mb-4" data-section-content="emoji-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-emoji-smile-fill icon-yellow me-2"></i><span data-i18n="chart.favoriteEmojis">Favorite emojis</span></h5>
						</div>
						<div class="card-body">
							<canvas id="mostUsedEmojisChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-emoji-laughing-fill icon-pink me-2"></i><span data-i18n="chart.emojisByUser">Emojis by user</span></h5>
						</div>
						<div class="card-body">
							<canvas id="emojiUsageByUserChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="sentiment-charts" class="row g-4 mb-4" data-section-content="sentiment-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-heart-pulse-fill icon-green me-2"></i><span data-i18n="chart.sentimentByUser">Sentiment by user</span></h5>
						</div>
						<div class="card-body">
							<canvas id="sentimentByUserChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-graph-up icon-cyan me-2"></i><span data-i18n="chart.sentimentTimeline">Sentiment timeline</span></h5>
						</div>
						<div class="card-body">
							<canvas id="sentimentTimelineChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div id="stats-charts" class="row g-4 mb-4" data-section-content="stats-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-pie-chart-fill icon-green me-2"></i><span data-i18n="chart.participation">Participation (message %)</span></h5>
						</div>
						<div class="card-body">
							<canvas id="responseRateChart" height="220"></canvas>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-trophy-fill icon-yellow me-2"></i><span data-i18n="chart.conversationStarters">Conversation starters</span></h5>
						</div>
						<div class="card-body">
							<div id="conversation-starters-podium" class="d-flex flex-column gap-3"></div>
						</div>
					</div>
				</div>
			</div>

			<div id="response-charts" class="row g-4 mb-4" data-section-content="response-charts">
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-lightning-fill icon-cyan me-2"></i><span data-i18n="chart.avgResponseTime">Avg. response time</span></h5>
						</div>
						<div class="card-body">
							<div id="response-time-chart-container">
								<canvas id="responseTimeChart" height="220"></canvas>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card h-100 stat-card animate-in" style="--delay: 3">
						<div class="card-header">
							<h5 class="mb-0"><i class="bi bi-pencil-fill icon-orange me-2"></i><span data-i18n="chart.avgWordsPerMessage">Avg. words per message</span></h5>
						</div>
						<div class="card-body">
							<canvas id="wordsPerMessageChart" height="220"></canvas>
						</div>
					</div>
				</div>
			</div>

			<div class="row mb-4">
				<div class="col-12">
					<div class="card download-section animate-in" style="--delay: 3">
						<div class="card-body d-flex justify-content-center gap-3 flex-wrap py-4">
							<button class="btn btn-outline-primary" id="download-json-btn">
								<i class="bi bi-filetype-json me-1"></i><span data-i18n="download.json">Download JSON</span>
							</button>
							<button class="btn btn-outline-primary" id="download-png-btn">
								<i class="bi bi-image me-1"></i><span data-i18n="download.png">Download PNG</span>
							</button>
						</div>
					</div>
				</div>
			</div>

			<div class="footer-note">
				<i class="bi bi-shield-lock-fill me-1"></i><span data-i18n="footer.privacy">Your data never leaves your browser. 100% private and secure.</span>
			</div>
		</div>

		<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form action="{{ url_for('dashboard') }}" method="POST" enctype="multipart/form-data">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
						<div class="modal-header">
							<h5 class="modal-title" id="uploadModalLabel" data-i18n="modal.title">Upload WhatsApp chat</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<p class="mb-2" data-i18n="modal.description">Export your chat without media and upload the .txt file.</p>
							<div class="mb-3">
								<label for="chatFile" class="form-label" data-i18n="modal.fileLabel">.txt file</label>
								<input class="form-control" type="file" id="chatFile" name="chatFile" accept=".txt" required />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="modal.cancel">Cancel</button>
							<button type="submit" class="btn btn-primary" data-i18n="modal.analyze">Analyze</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud@4"></script>
		<script id="chat-data" type="application/json">{{ stats_json | safe }}</script>
		<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
		<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
		<script>
			// Progress Navigation Bar functionality
			document.addEventListener('DOMContentLoaded', function () {
				const progressNavBar = document.getElementById('progressNavBar');
				const progressLine = document.getElementById('progressLine');
				const progressPoints = document.querySelectorAll('.progress-point');
				const sections = document.querySelectorAll('[data-section-content]');

				// Only show progress bar when stats are visible
				function updateProgressBarVisibility() {
					const statsContent = document.getElementById('stats-content');
					if (statsContent && !statsContent.classList.contains('d-none')) {
						progressNavBar.classList.add('visible');
					} else {
						progressNavBar.classList.remove('visible');
					}
				}

				// Update progress line and active points based on scroll
				function updateProgress() {
					if (!progressNavBar.classList.contains('visible')) return;

					const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
					const windowHeight = window.innerHeight;
					const documentHeight = document.documentElement.scrollHeight;

					let currentSection = null;
					let maxProgress = 0;

					// Find current section
					sections.forEach((section, index) => {
						const rect = section.getBoundingClientRect();
						const sectionTop = rect.top + scrollTop;
						const sectionBottom = sectionTop + rect.height;
						const threshold = windowHeight * 0.3;

						if (scrollTop + threshold >= sectionTop && scrollTop < sectionBottom) {
							currentSection = section.getAttribute('data-section-content');
							maxProgress = index;
						}
					});

					// Update active points
					progressPoints.forEach((point, index) => {
						if (index <= maxProgress) {
							point.classList.add('active');
						} else {
							point.classList.remove('active');
						}

						if (point.getAttribute('data-section') === currentSection) {
							point.classList.add('current');
						} else {
							point.classList.remove('current');
						}
					});

					// Update progress line height
					if (progressPoints.length > 0) {
						const firstPoint = progressPoints[0];
						const lastActivePoint = progressPoints[maxProgress];
						if (lastActivePoint) {
							const height = lastActivePoint.offsetTop - firstPoint.offsetTop;
							progressLine.style.height = `${height}px`;
						}
					}
				}

				// Smooth scroll to section
				progressPoints.forEach(point => {
					point.addEventListener('click', () => {
						const sectionName = point.getAttribute('data-section');
						const targetSection = document.querySelector(`[data-section-content="${sectionName}"]`);
						if (targetSection) {
							const offsetTop = targetSection.offsetTop - 80; // Account for navbar
							window.scrollTo({
								top: offsetTop,
								behavior: 'smooth'
							});
						}
					});
				});

				// Listen for scroll events
				let scrollTimeout;
				window.addEventListener('scroll', () => {
					clearTimeout(scrollTimeout);
					scrollTimeout = setTimeout(updateProgress, 10);
				});

				// Watch for stats content visibility changes
				const observer = new MutationObserver(updateProgressBarVisibility);
				const statsContent = document.getElementById('stats-content');
				if (statsContent) {
					observer.observe(statsContent, { attributes: true, attributeFilter: ['class'] });
				}

				// Initial update
				updateProgressBarVisibility();
				setTimeout(updateProgress, 100);
			});

			// Fix mobile navbar toggle - close menu when clicking links or outside
			document.addEventListener('DOMContentLoaded', function () {
				const navbarCollapse = document.getElementById('navbarSupportedContent');
				const navbarToggler = document.querySelector('.navbar-toggler');

				// Close navbar when clicking a nav link on mobile
				document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
					link.addEventListener('click', () => {
						if (window.innerWidth < 992 && navbarCollapse.classList.contains('show')) {
							bootstrap.Collapse.getInstance(navbarCollapse)?.hide();
						}
					});
				});

				// Close navbar when clicking outside
				document.addEventListener('click', (e) => {
					if (window.innerWidth < 992 &&
						navbarCollapse.classList.contains('show') &&
						!navbarCollapse.contains(e.target) &&
						!navbarToggler.contains(e.target)) {
						bootstrap.Collapse.getInstance(navbarCollapse)?.hide();
					}
				});
			});
		</script>

</body>

{% endblock %}